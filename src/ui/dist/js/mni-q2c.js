var map,trenchPath,lineSymbol,tPath=[],tPoly=[];let flcready=null,fmrReady=null,ftgReady=null,fltReady=null,ftpReady=null,ftdReady=null,ftppReady=null,retryMs=5e3,trenchId=null,mapVendor=null,trenchCoordinates={},trenchColor="#8B0000",trenchOpacity=1,mapCenter={lat:0,lng:0},mapRenderUrl=null,polyline=null,path=null,defaultCurrencyIsoCode="EUR",calcIsoCode="EUR",calcSymbol="€",calcCost=0,calcDistance=0,calcUnit="m",calcRate=1,kmlPolyColor="647800f0",mniStrokeColor="#F00078",mniStrokeOpacity=1,mniStrokeWeight=4;function jsonSortByMultiKeys(e,t){return Array.isArray(e)?e.sort(((e,n)=>{for(let o of t){if(e[o]<n[o])return-1;if(e[o]>n[o])return 1}return 0})):e}function trenchSave(){pathCoordinates.length>0&&(pathCoordinates=Array.from(new Set(pathCoordinates.map(JSON.stringify))).map(JSON.parse))}function saveToDisk(e,t,n="application/xml"){let o=new Blob([t],{type:n});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(o,e);else{const t=window.document.createElement("a");t.href=window.URL.createObjectURL(o),t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t)}}function trenchExportKml(){let e=document.getElementById("trenchPurpose"),t=document.getElementById("trenchId"),n=document.getElementById("trenchConstructionMethod"),o=t.options[t.selectedIndex].value,a=[];null!=path&&path.getLength()>0&&(path.forEach((e=>{a.push({x:e.lat(),y:e.lng()})})),a=Array.from(new Set(a.map(JSON.stringify))).map(JSON.parse));let l='<?xml version="1.0" encoding="UTF-8"?>\n';if(l+='<kml xmlns="http://www.opengis.net/kml/2.2" xmlns:mni="http://www.marlindt.net/mni/kml/ext/1.0">\n',l+="  <Document>\n",l+='    <Style id="MniLineStyle">\n',l+="      <LineStyle>\n",l+="        <color>"+kmlPolyColor+"</color>\n",l+="        <width>"+mniStrokeWeight+"</width>\n",l+="      </LineStyle>\n",l+="    </Style>\n",l+="    <name>"+document.getElementById("reference").value+"</name>\n",l+="    <open>1</open>\n",l+="    <description><![CDATA[<div>Trench proposal "+document.getElementById("reference").value+" generated "+document.getElementById("referenceDate").value+"</div>]]></description>\n",l+="    <LookAt>\n",a.length>0?(l+="      <longitude>"+a[0].y+"</longitude>\n",l+="      <latitude>"+a[0].x+"</latitude>\n"):(l+="      <longitude>0</longitude>\n",l+="      <latitude>0</latitude>\n"),l+="      <altitude>0</altitude>\n",l+="      <heading>0</heading>\n",l+="      <tilt>0</tilt>\n",l+="      <range>0</range>\n","-1"!=o&&(l+="      <mni:linkTrenchId>"+o+"</mni:linkTrenchId>\n"),l+="    </LookAt>\n",l+="    <Placemark>\n",l+="      <ExtendedData>\n",l+="        <mni:Q2cData>\n",l+="          <mni:Q2cReference>"+document.getElementById("reference").value+"</mni:Q2cReference>\n",l+="          <mni:Q2cDate>"+document.getElementById("referenceDate").value+"</mni:Q2cDate>\n",l+="          <mni:Q2cPurpose>"+e.options[e.selectedIndex].value+"</mni:Q2cPurpose>\n","unclassified"==e.options[e.selectedIndex].value&&(l+="          <mni:Q2cConstructionType>"+n.options[n.selectedIndex].value+"</mni:Q2cConstructionType>\n"),l+="          <mni:Q2cCurrencyIsoCode>"+calcIsoCode+"</mni:Q2cCurrencyIsoCode>\n",l+="          <mni:Q2cCurrencySymbol>"+calcSymbol+"</mni:Q2cCurrencySymbol>\n",l+="          <mni:Q2cCurrencyRateFromDefault>"+calcRate+"</mni:Q2cCurrencyRateFromDefault>\n",l+="          <mni:Q2cLength>"+calcDistance+"</mni:Q2cLength>\n",l+="          <mni:Q2cUnit>"+calcUnit+"</mni:Q2cUnit>\n",l+="          <mni:Q2cCost>"+calcCost+"</mni:Q2cCost>\n",l+="        </mni:Q2cData>\n",l+="      </ExtendedData>\n",l+="      <name>Proposed Path</name>\n",l+="      <styleUrl>#MniLineStyle</styleUrl>\n",l+="      <LineString>\n",l+="        <tessellate>1</tessellate>\n",l+="        <altitudeMode>clampToGround</altitudeMode>\n",l+="        <coordinates>\n",a.length>0)for(let e=0;e<a.length;e++)l+="          "+a[e].y+","+a[e].x+",0\n";l+="        </coordinates>\n",l+="      </LineString>\n",l+="    </Placemark>\n",l+="  </Document>\n",l+="</kml>",saveToDisk("mni-"+document.getElementById("reference").value+".kml",l,"application/xml")}function toggleConstruction(){let e=document.getElementById("trenchPurpose");"unclassified"==e.options[e.selectedIndex].value?(document.getElementById("trenchConstructionMethodLabel").hidden=!1,document.getElementById("trenchConstructionMethod").hidden=!1):(document.getElementById("trenchConstructionMethodLabel").hidden=!0,document.getElementById("trenchConstructionMethod").hidden=!0)}function trenchCalc(){document.getElementById("reference").value=generateUUID(),document.getElementById("referenceDate").value=(new Date).toISOString();let e=document.getElementById("trenchPurpose"),t=document.getElementById("trenchConstructionMethod"),n=document.getElementById("currency"),o=document.getElementById("trenchId"),a=o.options[o.selectedIndex].value,l={purpose:e.options[e.selectedIndex].value,isoCode:n.options[n.selectedIndex].value,coordinates:[]};"unclassified"==e.options[e.selectedIndex].value&&(l.type=t.options[t.selectedIndex].value),"-1"!=a&&(l.trenchId=a),null!=path&&path.getLength()>0&&(path.forEach((e=>{l.coordinates.push({x:e.lat(),y:e.lng()})})),l.coordinates=Array.from(new Set(l.coordinates.map(JSON.stringify))).map(JSON.parse)),l.coordinates.length>1?fetch(localStorage.getItem("mni.gatewayUrl")+"/q2c/trenchDistance",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(l),keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{null!=e&&(null!=e.distance&&null!=e.cost&&(calcIsoCode=e.isoCode,calcSymbol=e.symbol,calcRate=e.rate,calcCost=e.cost,calcDistance=e.distance,calcUnit=e.unit,document.getElementById("quotePanel").innerHTML=calcIsoCode+" "+calcSymbol+calcCost+"&emsp;&emsp;Distance: "+calcDistance+calcUnit),document.getElementById("savePath").hidden=!1,document.getElementById("exportKML").hidden=!1)})).catch((e=>{console.error(e)})):window.alert("At least two trench points are required")}function fetchListTrench(){null!=fltReady&&clearTimeout(fltReady),fetch(localStorage.getItem("mni.gatewayUrl")+"/trench",{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json();fltReady=setTimeout(fetchListTrench,retryMs)})).then((e=>{let t="<option disabled value='-1' selected='selected'> -- select a trench -- </option>";for(var n=0;n<e.length;n++)t+="<option value='"+e[n]+"' >"+e[n]+"</option>";document.getElementById("trenchId").innerHTML=t})).catch((e=>{fltReady=setTimeout(fetchListTrench,retryMs)}))}function fetchMapRender(){null!=fmrReady&&clearTimeout(fmrReady),fetch(localStorage.getItem("mni.gatewayUrl")+"/ui/mapRender",{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json();fmrReady=setTimeout(fetchMapRender,retryMs)})).then((e=>{null!=e.vendor&&(document.getElementById("mapVendor").innerHTML="<option value='"+e.vendor+"' selected='selected'>"+e.vendor+"</option>"),null!=e.url&&(mapRenderUrl=e.url+"&loading=async&callback=displayMap&v=weekly")})).catch((e=>{fmrReady=setTimeout(fetchMapRender,retryMs)}))}async function wipeMapClean(){for(let e=0;e<tPoly.length;e++)tPoly[e].setMap(null),tPoly[e]=null;tPoly.splice(0,tPoly.length),tPath.splice(0,tPath.length),null!=path&&(path.clear(),polyline.setPath(path),path=polyline.getPath()),document.getElementById("quotePanel").innerHTML="",document.getElementById("savePath").hidden=!0,document.getElementById("exportKML").hidden=!0,calcIsoCode="EUR",calcSymbol="€",calcCost=0,calcDistance=0,calcUnit="m",calcRate=1}async function wipePath(){null!=path&&(path.clear(),polyline.setPath(path),path=polyline.getPath()),document.getElementById("quotePanel").innerHTML="",document.getElementById("savePath").hidden=!0,document.getElementById("exportKML").hidden=!0,calcIsoCode="EUR",calcSymbol="€",calcCost=0,calcRate=1,calcDistance=0,calcUnit="m"}async function drawOnMap(){for(let e=0;e<trenchCoordinates.sets.length;e++){let t=trenchCoordinates.sets[e].point;"predicted"==trenchCoordinates.sets[e].source?(trenchOpacity=0,trenchColor=e%2==0?"#FFFF00":"#CCCC00"):(trenchOpacity=1,trenchColor=e%2==0?"#8B0000":"#FF6600"),tPath[t]=[];for(let e=0;e<trenchCoordinates[t].length;e++)tPath[t].push({lat:trenchCoordinates[t][e].x,lng:trenchCoordinates[t][e].y});tPoly[t]=new google.maps.Polyline({path:tPath[t],clickable:!1,strokeOpacity:trenchOpacity,strokeColor:trenchColor,strokeWeight:4,icons:[{icon:lineSymbol,offset:"0",repeat:"20px"}],map}),tPoly[t].setMap(map),polyline=new google.maps.Polyline({strokeColor:mniStrokeColor,strokeOpacity:mniStrokeOpacity,strokeWeight:mniStrokeWeight,map}),path=polyline.getPath(),map.addListener("click",(e=>{path.push(e.latLng)})),map.addListener("rightclick",(e=>{path.length>0&&(path.removeAt(path.getLength()-1),polyline.setPath(path))}))}}async function fetchTrenchGeometryLifetime(){null!=ftgReady&&clearTimeout(ftgReady);let e=document.getElementById("trenchId");trenchId=e.options[e.selectedIndex].value,await fetch(localStorage.getItem("mni.gatewayUrl")+"/trench/geometry/lifetime/"+trenchId,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json();ftgReady=setTimeout(fetchTrenchGeometryLifetime,retryMs)})).then((e=>{if(null!=e&&(trenchCoordinates={},trenchCoordinates=JSON.parse(JSON.stringify(e)),trenchCoordinates.sets.length>0)){let e=trenchCoordinates.sets[0].point;trenchCoordinates[e].length>0&&(mapCenter={lat:trenchCoordinates[e][0].x,lng:trenchCoordinates[e][0].y})}void 0!==document.getElementById("mapRender")&&null!=document.getElementById("mapRender")&&(map.setCenter(mapCenter),wipeMapClean(),drawOnMap())})).catch((e=>{ftgReady=setTimeout(fetchTrenchGeometryLifetime,retryMs)})),loadScript(mapRenderUrl,(function(){window.displayMap=function(){map=new google.maps.Map(document.getElementById("map"),{zoom:17,center:mapCenter,mapTypeId:"hybrid",disableDefaultUI:!0,draggableCursor:"crosshair"}),lineSymbol={path:"M 0,-1 0,1",strokeOpacity:1,scale:4},drawOnMap(),polyline=new google.maps.Polyline({strokeColor:"#eb34ba",strokeOpacity:1,strokeWeight:4,map}),path=polyline.getPath(),map.addListener("click",(e=>{path.push(e.latLng)})),map.addListener("rightclick",(e=>{path.length>0&&(path.removeAt(path.getLength()-1),polyline.setPath(path))}))}}))}function fetchListCurrency(){null!=flcReady&&clearTimeout(flcReady),fetch(localStorage.getItem("mni.gatewayUrl")+"/currency/default",{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json();flcReady=setTimeout(fetchListCurrency,retryMs)})).then((e=>{defaultCurrencyIsoCode=e.isoCode})).catch((e=>{flcReady=setTimeout(fetchListCurrency,retryMs)})),fetch(localStorage.getItem("mni.gatewayUrl")+"/currency",{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json();flcReady=setTimeout(fetchListCurrency,retryMs)})).then((e=>{e=jsonSortByMultiKeys(e,["name"]);let t="";for(var n=0;n<e.length;n++)e[n].isoCode==defaultCurrencyIsoCode?t+="<option value='"+e[n].isoCode+"' selected='selected'>"+e[n].name+" "+e[n].symbol+"</option>":t+="<option value='"+e[n].isoCode+"'>"+e[n].name+" "+e[n].symbol+"</option>";document.getElementById("currency").innerHTML=t})).catch((e=>{flcReady=setTimeout(fetchListCurrency,retryMs)}))}try{fetchListCurrency()}catch(e){flcReady=setTimeout(fetchListCurrency,retryMs)}try{fetchMapRender()}catch(e){fmrReady=setTimeout(fetchMapRender,retryMs)}try{fetchListTrench()}catch(e){fltReady=setTimeout(fetchListTrench,retryMs)}