var map,trenchPath,lineSymbol;let trenchId=null,point=null,mapVendor=null,trenchCoordinates=[],mapCenter={lat:0,lng:0},mapRenderUrl=null;var ductPanel=null,polePanel=null;let ductList="",poleList="";var tipObj=null;function injectTooltip(e,t){!tipObj&&e&&((tipObj=document.createElement("div")).setAttribute("class","mappolytooltip"),tipObj.innerHTML=t,document.body.appendChild(tipObj))}function deleteTooltip(e){tipObj&&(document.body.removeChild(tipObj),tipObj=null)}function fetchTrenchPremisesPassed(e,t){fetch(localStorage.getItem("mni.gatewayUrl")+"/trench/premisesPassed/"+e+"?point="+t,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{null!=e&&null!=e.passed&&document.getElementById("trenchPremisesPassed").setAttribute("value",e.passed)})).catch((e=>{console.error(e)}))}function fetchTrenchDistance(e,t){fetch(localStorage.getItem("mni.gatewayUrl")+"/trench/distance/"+e+"?point="+t,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{null!=e&&null!=e.distance&&null!=e.unit&&document.getElementById("trenchDistance").setAttribute("value",e.distance+e.unit)})).catch((e=>{console.error(e)}))}function fetchListTrench(){fetch(localStorage.getItem("mni.gatewayUrl")+"/trench?country="+mniSelectedCountry,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{let t=window.location.pathname.replace(localStorage.getItem("mni.rootUrl")+"/trench/",""),n="<option disabled value='-1' selected='selected'> -- select a trench -- </option>";null!=t&&(n="<option disabled value='-1'> -- select a trench -- </option>");for(var o=0;o<e.length;o++)t==e[o]?n+="<option value='"+e[o]+"' selected='selected'>"+e[o]+"</option>":n+="<option value='"+e[o]+"' >"+e[o]+"</option>";document.getElementById("trenchId").innerHTML=n,document.getElementById("trenchDistance").setAttribute("value",""),null!=t&&fetchTrenchPoints()})).catch((e=>{console.error(e)}))}function fetchTrenchPoints(){let e=document.getElementById("trenchId");try{trenchId=e.options[e.selectedIndex].value,"-1"!=trenchId&&fetch(localStorage.getItem("mni.gatewayUrl")+"/trench/timeline/"+trenchId,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{let t="<option disabled value='-1'> -- select a date/time -- </option>";for(var n=0;n<e.length;n++)t+=0==n?"<option selected='selected' value='"+e[n].point+"' >"+e[n].point+"</option>":"<option value='"+e[n].point+"' >"+e[n].point+"</option>";document.getElementById("trenchPoint").innerHTML=t,fetchTrenchGeometry()})).catch((e=>{console.error(e)}))}catch(e){}}function fetchMapRender(){fetch(localStorage.getItem("mni.gatewayUrl")+"/ui/mapRender",{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{null!=e.vendor&&(document.getElementById("mapVendor").innerHTML="<option value='"+e.vendor+"' selected='selected'>"+e.vendor+"</option>"),null!=e.url&&(mapRenderUrl=e.url+"&loading=async&callback=displayMap&v=weekly")})).catch((e=>{console.error(e)}))}function fetchTrenchGeometry(){let e=document.getElementById("trenchId");trenchId=e.options[e.selectedIndex].value;let t=document.getElementById("trenchPoint");point=t.options[t.selectedIndex].value,trenchCoordinates=[],mapCenter={lat:0,lng:0},fetch(localStorage.getItem("mni.gatewayUrl")+"/trench/"+trenchId+"?point="+point,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{if(null!=e){if(null!=e.pole){poleList="<ul>";for(let t=0;t<e.pole.length;t++)poleList+='<li><a href="'+localStorage.getItem("mni.rootUrl")+"/pole/"+e.pole[t]+"?country="+mniSelectedCountry+'">'+e.pole[t]+"</a></li>";poleList+="</ul>"}if(null!=e.duct){ductList="<ul>";for(let t=0;t<e.duct.length;t++)ductList+='<li><a href="'+localStorage.getItem("mni.rootUrl")+"/duct/"+e.duct[t]+"?country="+mniSelectedCountry+'">'+e.duct[t]+"</a></li>";ductList+="</ul>"}else ductList="<ul><li>none</li></ul>";if(e.coordinates.length>0){let t=Number.parseFloat(e.coordinates.length/2).toFixed(0);mapCenter={lat:e.coordinates[t].y,lng:e.coordinates[t].x}}else mapCenter={lat:0,lng:0};for(var t=0;t<e.coordinates.length;t++){let n={lat:e.coordinates[t].y,lng:e.coordinates[t].x};trenchCoordinates.push(n)}void 0!==document.getElementById("mapRender")&&null!=document.getElementById("mapRender")&&(map.setCenter(mapCenter),trenchPath.setMap(null),trenchPath.setPath(trenchCoordinates),trenchPath.setMap(map))}fetchTrenchDistance(trenchId,point),fetchTrenchPremisesPassed(trenchId,point)})).catch((e=>{console.error(e)})),loadScript(mapRenderUrl,(function(){window.displayMap=function(){map=new google.maps.Map(document.getElementById("map"),{zoom:17,center:mapCenter,mapTypeId:"hybrid",disableDefaultUI:!0}),lineSymbol={path:"M 0,-1 0,1",strokeOpacity:1,scale:4},(trenchPath=new google.maps.Polyline({path:trenchCoordinates,strokeOpacity:1,strokeColor:"#8B0000",strokeWeight:4,icons:[{icon:lineSymbol,offset:"0",repeat:"20px"}],map})).setMap(map),google.maps.event.addListener(trenchPath,"click",(function(e){(ductPanel=new google.maps.InfoWindow({headerContent:"Ducts",position:e.latLng,content:ductList})).open({shouldFocus:!0,map})})),google.maps.event.addListener(trenchPath,"mouseover",(function(e){injectTooltip(e,trenchId)})),google.maps.event.addListener(trenchPath,"mouseout",(function(e){deleteTooltip(e)})),google.maps.event.addListener(trenchPath,"rightclick",(function(e){(polePanel=new google.maps.InfoWindow({headerContent:"Poles",position:e.latLng,content:poleList})).open({shouldFocus:!0,map})}))}}))}try{fetchMapRender(),countryListPopulate(fetchListTrench)}catch(e){console.error(e)}