var trenchPath,lineSymbol,tPath=[],tPoly=[];let fmrReady=null,ftgReady=null,fltReady=null,ftpReady=null,ftdReady=null,ftppReady=null,retryMs=5e3,trenchId=null,mapVendor=null,trenchCoordinates={},trenchColor="#8B0000",trenchOpacity=1,startMarker=[],endMarker=[],mapCenter={lat:0,lng:0},mapRenderUrl=null;function fetchTrenchPremisesPassed(e,t){null!=ftppReady&&clearTimeout(ftppReady),fetch(localStorage.getItem("mni.gatewayUrl")+"/trench/premisesPassed/"+e+"?point="+t,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((n=>{if(n.ok)return n.json();ftppReady=setTimeout(fetchTrenchPremisesPassed,retryMs,e,t)})).then((e=>{null!=e&&null!=e.passed&&document.getElementById("trenchPremisesPassed").setAttribute("value",e.passed)})).catch((n=>{ftppReady=setTimeout(fetchTrenchPremisesPassed,retryMs,e,t)}))}function fetchTrenchDistance(e,t){null!=ftdReady&&clearTimeout(ftdReady),fetch(localStorage.getItem("mni.gatewayUrl")+"/trench/distance/"+e+"?point="+t,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((n=>{if(n.ok)return n.json();ftdReady=setTimeout(fetchTrenchDistance,retryMs,e,t)})).then((e=>{null!=e&&null!=e.distance&&null!=e.unit&&document.getElementById("trenchDistance").setAttribute("value",e.distance+e.unit)})).catch((n=>{ftdReady=setTimeout(fetchTrenchDistance,retryMs,e,t)}))}function fetchListTrench(){null!=fltReady&&clearTimeout(fltReady),fetch(localStorage.getItem("mni.gatewayUrl")+"/trench",{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json();fltReady=setTimeout(fetchListTrench,retryMs)})).then((e=>{let t="<option disabled value='-1' selected='selected'> -- select a trench -- </option>";for(var n=0;n<e.length;n++)t+="<option value='"+e[n]+"' >"+e[n]+"</option>";document.getElementById("trenchId").innerHTML=t,document.getElementById("trenchDistance").setAttribute("value","")})).catch((e=>{fltReady=setTimeout(fetchListTrench,retryMs)}))}function fetchMapRender(){null!=fmrReady&&clearTimeout(fmrReady),fetch(localStorage.getItem("mni.gatewayUrl")+"/ui/mapRender",{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json();fmrReady=setTimeout(fetchMapRender,retryMs)})).then((e=>{null!=e.vendor&&(document.getElementById("mapVendor").innerHTML="<option value='"+e.vendor+"' selected='selected'>"+e.vendor+"</option>"),null!=e.url&&(mapRenderUrl=e.url+"&loading=async&callback=displayMap&v=weekly")})).catch((e=>{fmrReady=setTimeout(fetchMapRender,retryMs)}))}async function wipeMapClean(){for(let e=0;e<startMarker.length;e++)startMarker[e].setMap(null),startMarker[e]=null;for(let e=0;e<endMarker.length;e++)endMarker[e].setMap(null),endMarker[e]=null;for(let e=0;e<tPoly.length;e++)tPoly[e].setMap(null),tPoly[e]=null;startMarker.splice(0,startMarker.length),endMarker.splice(0,endMarker.length),tPoly.splice(0,tPoly.length),tPath.splice(0,tPath.length)}async function drawOnMap(){trenchCoordinates.sets.length>0&&(fetchTrenchPremisesPassed(trenchId,trenchCoordinates.sets[trenchCoordinates.sets.length-1].point),fetchTrenchDistance(trenchId,trenchCoordinates.sets[trenchCoordinates.sets.length-1].point));for(let e=0;e<trenchCoordinates.sets.length;e++){let t=trenchCoordinates.sets[e].point;"predicted"==trenchCoordinates.sets[e].source?(trenchOpacity=0,trenchColor=e%2==0?"#FFFF00":"#CCCC00"):(trenchOpacity=1,trenchColor=e%2==0?"#8B0000":"#FF6600"),tPath[t]=[];for(let e=0;e<trenchCoordinates[t].length;e++)0==e&&(startMarker[t]=new google.maps.Marker({position:{lat:trenchCoordinates[t][e].x,lng:trenchCoordinates[t][e].y},icon:{path:google.maps.SymbolPath.CIRCLE,scale:6,strokeOpacity:0,strokeColor:trenchColor,fillOpacity:1,fillColor:trenchColor},map,title:t})),e==trenchCoordinates[t].length-1&&e>0&&(endMarker[t]=new google.maps.Marker({position:{lat:trenchCoordinates[t][e].x,lng:trenchCoordinates[t][e].y},icon:{path:google.maps.SymbolPath.CIRCLE,scale:6,strokeOpacity:0,strokeColor:trenchColor,fillOpacity:1,fillColor:trenchColor},map,title:t})),tPath[t].push({lat:trenchCoordinates[t][e].x,lng:trenchCoordinates[t][e].y});tPoly[t]=new google.maps.Polyline({path:tPath[t],strokeOpacity:trenchOpacity,strokeColor:trenchColor,strokeWeight:4,icons:[{icon:lineSymbol,offset:"0",repeat:"20px"}],map}),tPoly[t].setMap(map)}}async function fetchTrenchGeometryLifetime(){null!=ftgReady&&clearTimeout(ftgReady);let e=document.getElementById("trenchId");trenchId=e.options[e.selectedIndex].value,await fetch(localStorage.getItem("mni.gatewayUrl")+"/trench/geometry/lifetime/"+trenchId,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json();ftgReady=setTimeout(fetchTrenchGeometryLifetime,retryMs)})).then((e=>{if(null!=e&&(trenchCoordinates={},trenchCoordinates=JSON.parse(JSON.stringify(e)),trenchCoordinates.sets.length>0)){let e=trenchCoordinates.sets[0].point;trenchCoordinates[e].length>0&&(mapCenter={lat:trenchCoordinates[e][0].x,lng:trenchCoordinates[e][0].y})}void 0!==document.getElementById("mapRender")&&null!=document.getElementById("mapRender")&&(map.setCenter(mapCenter),wipeMapClean(),drawOnMap())})).catch((e=>{ftgReady=setTimeout(fetchTrenchGeometryLifetime,retryMs)})),loadScript(mapRenderUrl,(function(){window.displayMap=function(){map=new google.maps.Map(document.getElementById("map"),{zoom:17,center:mapCenter,mapTypeId:"hybrid",disableDefaultUI:!0}),lineSymbol={path:"M 0,-1 0,1",strokeOpacity:1,scale:4},drawOnMap()}}))}try{fetchMapRender()}catch(e){fmrReady=setTimeout(fetchMapRender,retryMs)}try{fetchListTrench()}catch(e){fltReady=setTimeout(fetchListTrench,retryMs)}