var map,trenchPath,lineSymbol,tPath=[],tPoly=[];let trenchId=null,mapVendor=null,trenchCoordinates={},trenchColor="#8B0000",trenchOpacity=1,mapCenter={lat:0,lng:0},mapRenderUrl=null,polyline=null,path=null,defaultCurrencyIsoCode="GBP",calcIsoCode="GBP",calcSymbol="£",calcCost=0,calcDistance=0,calcUnit="m",calcRate=1,kmlPolyColor="647800f0",niStrokeColor="#F00078",niStrokeOpacity=1,niStrokeWeight=4;function jsonSortByMultiKeys(e,t){return Array.isArray(e)?e.sort(((e,n)=>{for(let o of t){if(e[o]<n[o])return-1;if(e[o]>n[o])return 1}return 0})):e}function trenchSave(){pathCoordinates.length>0&&(pathCoordinates=Array.from(new Set(pathCoordinates.map(JSON.stringify))).map(JSON.parse))}function saveToDisk(e,t,n="application/xml"){let o=new Blob([t],{type:n});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveBlob(o,e);else{const t=window.document.createElement("a");t.href=window.URL.createObjectURL(o),t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t)}}function trenchExportKml(){let e=document.getElementById("trenchPurpose"),t=document.getElementById("trenchId"),n=document.getElementById("trenchConstructionMethod"),o=t.options[t.selectedIndex].value,l=[];null!=path&&path.getLength()>0&&(path.forEach((e=>{l.push({x:e.lng(),y:e.lat()})})),l=Array.from(new Set(l.map(JSON.stringify))).map(JSON.parse));let a='<?xml version="1.0" encoding="UTF-8"?>\n';if(a+='<kml xmlns="http://www.opengis.net/kml/2.2" xmlns:ni="http://www.cowdrey.net/ni/kml/ext/1.0">\n',a+="  <Document>\n",a+='    <Style id="niLineStyle">\n',a+="      <LineStyle>\n",a+="        <color>"+kmlPolyColor+"</color>\n",a+="        <width>"+niStrokeWeight+"</width>\n",a+="      </LineStyle>\n",a+="    </Style>\n",a+="    <name>"+document.getElementById("reference").value+"</name>\n",a+="    <open>1</open>\n",a+="    <description><![CDATA[<div>Trench proposal "+document.getElementById("reference").value+" generated "+document.getElementById("referenceDate").value+"</div>]]></description>\n",a+="    <LookAt>\n",l.length>0?(a+="      <longitude>"+l[0].x+"</longitude>\n",a+="      <latitude>"+l[0].y+"</latitude>\n"):(a+="      <longitude>0</longitude>\n",a+="      <latitude>0</latitude>\n"),a+="      <altitude>0</altitude>\n",a+="      <heading>0</heading>\n",a+="      <tilt>0</tilt>\n",a+="      <range>0</range>\n","-1"!=o&&(a+="      <ni:linkTrenchId>"+o+"</ni:linkTrenchId>\n"),a+="    </LookAt>\n",a+="    <Placemark>\n",a+="      <ExtendedData>\n",a+="        <ni:Q2cData>\n",a+="          <ni:Q2cReference>"+document.getElementById("reference").value+"</ni:Q2cReference>\n",a+="          <ni:Q2cDate>"+document.getElementById("referenceDate").value+"</ni:Q2cDate>\n",a+="          <ni:Q2cPurpose>"+e.options[e.selectedIndex].value+"</ni:Q2cPurpose>\n","unclassified"==e.options[e.selectedIndex].value&&(a+="          <ni:Q2cConstructionType>"+n.options[n.selectedIndex].value+"</ni:Q2cConstructionType>\n"),a+="          <ni:Q2cCurrencyIsoCode>"+calcIsoCode+"</ni:Q2cCurrencyIsoCode>\n",a+="          <ni:Q2cCurrencySymbol>"+calcSymbol+"</ni:Q2cCurrencySymbol>\n",a+="          <ni:Q2cCurrencyRateFromDefault>"+calcRate+"</ni:Q2cCurrencyRateFromDefault>\n",a+="          <ni:Q2cLength>"+calcDistance+"</ni:Q2cLength>\n",a+="          <ni:Q2cUnit>"+calcUnit+"</ni:Q2cUnit>\n",a+="          <ni:Q2cCost>"+calcCost+"</ni:Q2cCost>\n",a+="        </ni:Q2cData>\n",a+="      </ExtendedData>\n",a+="      <name>Proposed Path</name>\n",a+="      <styleUrl>#niLineStyle</styleUrl>\n",a+="      <LineString>\n",a+="        <tessellate>1</tessellate>\n",a+="        <altitudeMode>clampToGround</altitudeMode>\n",a+="        <coordinates>\n",l.length>0)for(let e=0;e<l.length;e++)a+="          "+l[e].x+","+l[e].y+",0\n";a+="        </coordinates>\n",a+="      </LineString>\n",a+="    </Placemark>\n",a+="  </Document>\n",a+="</kml>",saveToDisk("ni-"+document.getElementById("reference").value+".kml",a,"application/xml")}function toggleConstruction(){let e=document.getElementById("trenchPurpose");"unclassified"==e.options[e.selectedIndex].value?(document.getElementById("trenchConstructionMethodLabel").hidden=!1,document.getElementById("trenchConstructionMethod").hidden=!1):(document.getElementById("trenchConstructionMethodLabel").hidden=!0,document.getElementById("trenchConstructionMethod").hidden=!0)}function trenchCalc(){document.getElementById("reference").value=generateUUID(),document.getElementById("referenceDate").value=(new Date).toISOString();let e=document.getElementById("trenchPurpose"),t=document.getElementById("trenchConstructionMethod"),n=document.getElementById("currency"),o=document.getElementById("trenchId"),l=o.options[o.selectedIndex].value,a={purpose:e.options[e.selectedIndex].value,isoCode:n.options[n.selectedIndex].value,coordinates:[]};"unclassified"==e.options[e.selectedIndex].value&&(a.type=t.options[t.selectedIndex].value),"-1"!=l&&(a.trenchId=l),null!=path&&path.getLength()>0&&(path.forEach((e=>{a.coordinates.push({x:e.lng(),y:e.lat()})})),a.coordinates=Array.from(new Set(a.coordinates.map(JSON.stringify))).map(JSON.parse)),a.coordinates.length>1?fetch(localStorage.getItem("ni.gatewayUrl")+"/q2c/trenchDistance",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(a),keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{null!=e&&(null!=e.distance&&null!=e.cost&&(calcIsoCode=e.isoCode,calcSymbol=e.symbol,calcRate=e.rate,calcCost=e.cost,calcDistance=e.distance,calcUnit=e.unit,document.getElementById("quotePanel").innerHTML=calcIsoCode+" "+calcSymbol+calcCost+"&emsp;&emsp;Distance: "+calcDistance+calcUnit),document.getElementById("savePath").hidden=!1,document.getElementById("exportKML").hidden=!1)})).catch((e=>{console.error(e)})):window.alert("At least two trench points are required")}function fetchListTrench(){let e=document.getElementById("country"),t=e.options[e.selectedIndex].value;fetch(localStorage.getItem("ni.gatewayUrl")+"/trench?country="+t,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{let t="<option disabled value='-1' selected='selected'> -- select a trench -- </option>";for(var n=0;n<e.length;n++)t+="<option value='"+e[n]+"' >"+e[n]+"</option>";document.getElementById("trenchId").innerHTML=t})).catch((e=>{console.error(e)}))}function fetchMapRender(){fetch(localStorage.getItem("ni.gatewayUrl")+"/ui/mapRender",{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{null!=e.vendor&&(document.getElementById("mapVendor").innerHTML="<option value='"+e.vendor+"' selected='selected'>"+e.vendor+"</option>"),null!=e.url&&(mapRenderUrl=e.url+"&loading=async&callback=displayMap&v=weekly")})).catch((e=>{console.error(e)}))}async function wipeMapClean(){if(Object.keys(tPoly).length>0)for(let e in tPoly)tPoly[e].setMap(null),tPoly[e]=null;tPoly=[],tPath=[],null!=path&&(path.clear(),polyline.setPath(path),path=polyline.getPath()),document.getElementById("quotePanel").innerHTML="",document.getElementById("savePath").hidden=!0,document.getElementById("exportKML").hidden=!0,calcIsoCode="EUR",calcSymbol="€",calcCost=0,calcDistance=0,calcUnit="m",calcRate=1}async function wipePath(){null!=path&&(path.clear(),polyline.setPath(path),path=polyline.getPath()),document.getElementById("quotePanel").innerHTML="",document.getElementById("savePath").hidden=!0,document.getElementById("exportKML").hidden=!0,calcIsoCode="EUR",calcSymbol="€",calcCost=0,calcRate=1,calcDistance=0,calcUnit="m"}async function drawOnMap(){try{if(Object.keys(tPoly).length>0){for(let e in tPoly)tPoly[e].setMap(null),tPoly[e]=null;tPoly=[],tPath=[]}for(let e=0;e<trenchCoordinates.sets.length;e++){let t=trenchCoordinates.sets[e].point;"predicted"==trenchCoordinates.sets[e].source?(trenchOpacity=0,trenchColor=e%2==0?"#FFFF00":"#CCCC00"):(trenchOpacity=1,trenchColor=e%2==0?"#8B0000":"#FF6600"),tPath[t]=[];for(let e=0;e<trenchCoordinates[t].length;e++)tPath[t].push({lat:trenchCoordinates[t][e].y,lng:trenchCoordinates[t][e].x});tPoly[t]=new google.maps.Polyline({path:tPath[t],clickable:!1,strokeOpacity:trenchOpacity,strokeColor:trenchColor,strokeWeight:4,icons:[{icon:lineSymbol,offset:"0",repeat:"20px"}],map}),tPoly[t].setMap(map),polyline=new google.maps.Polyline({strokeColor:niStrokeColor,strokeOpacity:niStrokeOpacity,strokeWeight:niStrokeWeight,map}),path=polyline.getPath(),map.addListener("click",(e=>{path.push(e.latLng)})),map.addListener("rightclick",(e=>{path.length>0&&(path.removeAt(path.getLength()-1),polyline.setPath(path))}))}}catch(e){console.error(e)}}async function fetchTrenchGeometryLifetime(){let e=document.getElementById("trenchId");trenchId=e.options[e.selectedIndex].value,await fetch(localStorage.getItem("ni.gatewayUrl")+"/trench/geometry/lifetime/"+trenchId,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{if(null!=e&&(trenchCoordinates={},trenchCoordinates=JSON.parse(JSON.stringify(e)),trenchCoordinates.sets.length>0)){let e=trenchCoordinates.sets[0].point;trenchCoordinates[e].length>0&&(mapCenter={lng:trenchCoordinates[e][0].x,lat:trenchCoordinates[e][0].y})}void 0!==document.getElementById("mapRender")&&null!=document.getElementById("mapRender")&&(map.setCenter(mapCenter),drawOnMap())})).catch((e=>{console.error(e)})),loadScript(mapRenderUrl,(function(){window.displayMap=function(){map=new google.maps.Map(document.getElementById("map"),{zoom:17,center:mapCenter,mapTypeId:"hybrid",disableDefaultUI:!0,draggableCursor:"crosshair"}),lineSymbol={path:"M 0,-1 0,1",strokeOpacity:1,scale:4},map.setCenter(mapCenter),drawOnMap(),polyline=new google.maps.Polyline({strokeColor:"#eb34ba",strokeOpacity:1,strokeWeight:4,map}),path=polyline.getPath(),map.addListener("click",(e=>{path.push(e.latLng)})),map.addListener("rightclick",(e=>{path.length>0&&(path.removeAt(path.getLength()-1),polyline.setPath(path))}))}}))}function fetchListCurrency(){fetch(localStorage.getItem("ni.gatewayUrl")+"/currency/default",{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{defaultCurrencyIsoCode=e.isoCode})).catch((e=>{console.error(e)})),fetch(localStorage.getItem("ni.gatewayUrl")+"/currency",{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{e=jsonSortByMultiKeys(e,["name"]);let t="";for(var n=0;n<e.length;n++)e[n].isoCode==defaultCurrencyIsoCode?t+="<option value='"+e[n].isoCode+"' selected='selected'>"+e[n].name+" "+e[n].symbol+"</option>":t+="<option value='"+e[n].isoCode+"'>"+e[n].name+" "+e[n].symbol+"</option>";document.getElementById("currency").innerHTML=t})).catch((e=>{console.error(e)}))}try{fetchListCurrency(),fetchMapRender(),countryListPopulate(fetchListTrench),countryListPopulate()}catch(e){console.error(e)}