var trenchPath,lineSymbol,tPath=[],tPoly=[];let trenchId=null,mapVendor=null,trenchCoordinates={},trenchColor="#8B0000",trenchOpacity=1,startMarker=[],endMarker=[],mapCenter={lat:0,lng:0},mapRenderUrl=null;var ductPanel=null,polePanel=null;let ductList="",poleList="";var tipObj=null;function injectTooltip(e,t){!tipObj&&e&&((tipObj=document.createElement("div")).setAttribute("class","mappolytooltip"),tipObj.innerHTML=t,document.body.appendChild(tipObj))}function deleteTooltip(e){tipObj&&(document.body.removeChild(tipObj),tipObj=null)}function fetchTrenchPremisesPassed(e,t){fetch(localStorage.getItem("ni.gatewayUrl")+"/trench/premisesPassed/"+e+"?point="+t,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{null!=e&&null!=e.passed&&document.getElementById("trenchPremisesPassed").setAttribute("value",e.passed)})).catch((e=>{console.error(e)}))}function fetchTrenchDistance(e,t){fetch(localStorage.getItem("ni.gatewayUrl")+"/trench/distance/"+e+"?point="+t,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{null!=e&&null!=e.distance&&null!=e.unit&&document.getElementById("trenchDistance").setAttribute("value",e.distance+e.unit)})).catch((e=>{console.error(e)}))}function fetchListTrench(){fetch(localStorage.getItem("ni.gatewayUrl")+"/trench?country="+niSelectedCountry,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{let t=window.location.pathname.replace(localStorage.getItem("ni.rootUrl")+"/trenchLifetime/",""),n="<option disabled value='-1' selected='selected'> -- select a trench -- </option>";null!=t&&(n="<option disabled value='-1'> -- select a trench -- </option>");for(var o=0;o<e.length;o++)t==e[o]?n+="<option value='"+e[o]+"' selected='selected'>"+e[o]+"</option>":n+="<option value='"+e[o]+"' >"+e[o]+"</option>";document.getElementById("trenchId").innerHTML=n,document.getElementById("trenchDistance").setAttribute("value",""),null!=t&&fetchTrenchGeometryLifetime()})).catch((e=>{console.error(e)}))}function fetchMapRender(){fetch(localStorage.getItem("ni.gatewayUrl")+"/ui/mapRender",{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{null!=e.vendor&&(document.getElementById("mapVendor").innerHTML="<option value='"+e.vendor+"' selected='selected'>"+e.vendor+"</option>"),null!=e.url&&(mapRenderUrl=e.url+"&loading=async&callback=displayMap&v=weekly")})).catch((e=>{console.error(e)}))}async function wipeMapClean(){if(null!=startMarker){for(let e=0;e<startMarker.length;e++)startMarker[e].setMap(null),startMarker[e]=null;startMarker.splice(0,startMarker.length)}if(null!=endMarker){for(let e=0;e<endMarker.length;e++)endMarker[e].setMap(null),endMarker[e]=null;endMarker.splice(0,endMarker.length)}if(Object.keys(tPoly).length>0){for(let e in tPoly)tPoly[e].setMap(null),tPoly[e]=null;tPoly=[]}null!=tPath&&tPath.splice(0,tPath.length)}async function drawOnMap(){trenchCoordinates.sets.length>0&&(fetchTrenchPremisesPassed(trenchId,trenchCoordinates.sets[trenchCoordinates.sets.length-1].point),fetchTrenchDistance(trenchId,trenchCoordinates.sets[trenchCoordinates.sets.length-1].point));for(let e=0;e<trenchCoordinates.sets.length;e++){let t=trenchCoordinates.sets[e].point;"predicted"==trenchCoordinates.sets[e].source?(trenchOpacity=0,trenchColor=e%2==0?"#FFFF00":"#CCCC00"):(trenchOpacity=1,trenchColor=e%2==0?"#8B0000":"#FF6600"),tPath[t]=[];for(let e=0;e<trenchCoordinates[t].length;e++)0==e&&(startMarker[t]=new google.maps.Marker({position:{lat:trenchCoordinates[t][e].y,lng:trenchCoordinates[t][e].x},icon:{path:google.maps.SymbolPath.CIRCLE,scale:6,strokeOpacity:0,strokeColor:trenchColor,fillOpacity:1,fillColor:trenchColor},map,title:t})),e==trenchCoordinates[t].length-1&&e>0&&(endMarker[t]=new google.maps.Marker({position:{lat:trenchCoordinates[t][e].y,lng:trenchCoordinates[t][e].x},icon:{path:google.maps.SymbolPath.CIRCLE,scale:6,strokeOpacity:0,strokeColor:trenchColor,fillOpacity:1,fillColor:trenchColor},map,title:t})),tPath[t].push({lat:trenchCoordinates[t][e].y,lng:trenchCoordinates[t][e].x});tPoly[t]=new google.maps.Polyline({path:tPath[t],strokeOpacity:trenchOpacity,strokeColor:trenchColor,strokeWeight:4,icons:[{icon:lineSymbol,offset:"0",repeat:"20px"}],map}),tPoly[t].setMap(map),google.maps.event.addListener(tPoly[t],"click",(function(e){(ductPanel=new google.maps.InfoWindow({headerContent:"Ducts",position:e.latLng,content:"<ul><li>none</li></ul>"})).open({shouldFocus:!0,map})})),google.maps.event.addListener(tPoly[t],"mouseover",(function(e){injectTooltip(e,trenchId)})),google.maps.event.addListener(tPoly[t],"mouseout",(function(e){deleteTooltip(e)})),google.maps.event.addListener(tPoly[t],"rightclick",(function(e){(polePanel=new google.maps.InfoWindow({headerContent:"Poles",position:e.latLng,content:"<ul><li>none</li></ul>"})).open({shouldFocus:!0,map})}))}}async function fetchTrenchGeometryLifetime(){let e=document.getElementById("trenchId");trenchId=e.options[e.selectedIndex].value,await fetch(localStorage.getItem("ni.gatewayUrl")+"/trench/geometry/lifetime/"+trenchId,{method:"GET",headers:{Accept:"application/json"},keepalive:!0}).then((e=>{if(e.ok)return e.json()})).then((e=>{if(null!=e&&(trenchCoordinates={},trenchCoordinates=JSON.parse(JSON.stringify(e)),trenchCoordinates.sets.length>0)){let e=trenchCoordinates.sets[0].point;trenchCoordinates[e].length>0&&(mapCenter={lat:trenchCoordinates[e][0].y,lng:trenchCoordinates[e][0].x})}void 0!==document.getElementById("mapRender")&&null!=document.getElementById("mapRender")&&(map.setCenter(mapCenter),wipeMapClean(),drawOnMap())})).catch((e=>{console.error(e)})),loadScript(mapRenderUrl,(function(){window.displayMap=function(){map=new google.maps.Map(document.getElementById("map"),{zoom:17,center:mapCenter,mapTypeId:"hybrid",disableDefaultUI:!0}),lineSymbol={path:"M 0,-1 0,1",strokeOpacity:1,scale:4},drawOnMap()}}))}try{fetchMapRender(),countryListPopulate(fetchListTrench)}catch(e){console.error(e)}