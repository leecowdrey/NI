<!doctype html>
<html class="no-js" lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MNI</title>
    <link rel="stylesheet" href="/mni/css/style.css">
    <link rel="stylesheet" href="/mni/css/font-awesome.min.css">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="apple-touch-icon" href="img/icon.png">
    <style>
        .panel {
            width: 30%;
            height: 40%;
            border-radius: 10px;
            background-color: #b3b3b3;
            color: #ffffff;
            text-align: center;
            margin-top: 20px;
            margin-left: 20px;
            display: inline-block;
        }

        .map {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            margin-top: 5px;
            min-height: 86vh;
        }
    </style>
    <script async src="/mni/js/mni.js"></script>
</head>

<body>
    <script>
        var map;
        var polePath;
        var lineSymbol;
        let fmrReady = null;
        let ftgReady = null;
        let fltReady = null;
        let fppReady = null;
        let retryMs = 5000;
        let poleId = null;
        let point = null;
        let mapVendor = null;
        let poleX = 0;
        let poleY = 0;
        let marker = null;
        let endMarker = null;
        let mapCenter = { lat: 0, lng: 0 };
        let mapRenderUrl = null;
        function fetchListPoles() {
            if (fltReady != null) {
                clearTimeout(fltReady);
            }

            fetch("<%=payload.gatewayUrl%>/pole", {
                method: "GET",
                headers: {
                    "Accept": "application/json",
                },
            })
                .then((response) => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        fltReady = setTimeout(fetchMapRender, retryMs);
                    }
                })
                .then((data) => {
                    let poleIds = "<option disabled value='-1' selected='selected'> -- select a pole -- </option>";
                    for (var i = 0; i < data.length; i++) {
                        poleIds += "<option value='" + data[i] + "' >" + data[i] + "</option>"
                    }
                    document.getElementById("poleId").innerHTML = poleIds;
                    document.getElementById("poleHeight").setAttribute("value", "");
                    document.getElementById("poleClassifier").setAttribute("value", "");
                })
                .catch((e) => {
                    fltReady = setTimeout(fetchMapRender, retryMs);
                });

        }
        function fetchPolePoints() {
            if (fppReady != null) {
                clearTimeout(fppReady);
            }

            let t = document.getElementById("poleId");
            poleId = t.options[t.selectedIndex].value;
            if (poleId != "-1") {
                fetch("<%=payload.gatewayUrl%>/pole/timeline/" + poleId, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                    },
                })
                    .then((response) => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            fppReady = setTimeout(fetchMapRender, retryMs);
                        }
                    })
                    .then((data) => {
                        let polePoints = "<option disabled value='-1' selected='selected'> -- select a date/time point -- </option>";
                        for (var i = 0; i < data.length; i++) {
                            polePoints += "<option value='" + data[i].point + "' >" + data[i].point + "</option>"
                        }
                        document.getElementById("polePoint").innerHTML = polePoints;
                    })
                    .catch((e) => {
                        fppReady = setTimeout(fetchMapRender, retryMs);
                    });
            }

        }
        function fetchMapRender() {
            if (fmrReady != null) {
                clearTimeout(fmrReady);
            }

            fetch("<%=payload.gatewayUrl%>/ui/mapRender", {
                method: "GET",
                headers: {
                    "Accept": "application/json",
                },
            })
                .then((response) => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        fmrReady = setTimeout(fetchMapRender, retryMs);
                    }
                })
                .then((data) => {
                    if (data.vendor != null) {
                        document.getElementById("mapVendor").innerHTML = "<option value='" + data.vendor + "' selected='selected'>" + data.vendor + "</option>";
                        // <option disabled value='OpenStreet Map'>OpenStreet Map</option>
                        // <option disabled value='Microsoft Azure'>Microsoft Azure</option>
                        // <option disabled value='ERSI'>ERSI</option>
                    }
                    if (data.url != null) {
                        mapRenderUrl = data.url + "&loading=async&callback=displayMap&v=weekly";
                    }
                })
                .catch((e) => {
                    fmrReady = setTimeout(fetchMapRender, retryMs);
                });

        }
        function fetchPole() {
            if (ftgReady != null) {
                clearTimeout(ftgReady);
            }
            let t = document.getElementById("poleId");
            poleId = t.options[t.selectedIndex].value;
            let p = document.getElementById("polePoint");
            point = p.options[p.selectedIndex].value;
            poleCoordinates = [];
            mapCenter = { lat: 0, lng: 0 };
            if (poleId != "-1" && point != "-1") {
                fetch("<%=payload.gatewayUrl%>/pole/" + poleId + "?point=" + point, {
                    method: "GET",
                    headers: {
                        "Accept": "application/json",
                    },
                })
                    .then((response) => {
                        if (response.ok) {
                            return response.json();
                        } else {
                            ftgReady = setTimeout(fetchPole, retryMs);
                        }
                    })
                    .then((data) => {
                        if (data != null) {
                            poleX = data.coordinate.x;
                            poleY = data.coordinate.y;
                            if (document.getElementById("mapRender") !== undefined && document.getElementById("mapRender") != null) {
                                map.setCenter({ lat: poleX, lng: poleY });
                                if (marker != null) {
                                    marker.setMap(null);
                                }
                                marker.setPosition({ lat: poleX, lng: poleY });
                                marker.setMap(map);
                            }
                            if (data.construction?.height != null && data.construction?.unit != null) {
                                document.getElementById("poleHeight").setAttribute("value", data.construction.height + data.construction.unit);
                            }
                            if (data.construction?.classifier != null) {
                                document.getElementById("poleClassifier").setAttribute("value", data.construction.classifier);
                            }
                        }
                    })
                    .catch((e) => {
                        ftgReady = setTimeout(fetchPole, retryMs);
                    });
                loadScript(mapRenderUrl, function () {
                    function displayMap() {
                        map = new google.maps.Map(document.getElementById("map"), {
                            zoom: 30,
                            center: { lat: poleX, lng: poleY },
                            mapTypeId: "hybrid",
                            disableDefaultUI: true,
                        });
                        marker = new google.maps.Marker({
                            position: { lat: poleX, lng: poleY },
                            icon: {
                                path: "M 0,0 V15 M -4,4 H4",
                                strokeOpacity: 1,
                                fillColor: "#8B0000",
                                fillOpacity: 1,
                                strokeColor: "#8B0000",
                                strokeWeight: 6,
                                scale: 4,
                            },
                            map: map,
                        });
                    }
                    window.displayMap = displayMap;
                });
            }
        }
        try {
            fetchMapRender();
        } catch (e) {
            fmrReady = setTimeout(fetchMapRender, retryMs);
        }
        try {
            fetchListPoles();
        } catch (e) {
            fltReady = setTimeout(fetchListPoles, retryMs);
        }
    </script>
    <link rel="stylesheet" href="/mni/css/font-awesome.min.css">
    <div class="icon-bar" id="icon-bar">
        <a nohref onmouseover="" style="cursor: pointer;" title="MarlinDT Network Intelligence"><img src="/favicon.ico"
                width="25%" height="25%"></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/dashboard');"
            title="Dashboard"><i class="fa fa-thermometer-half"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/cable');"
            title="Cables"><i class="fa fa-plug"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/duct');"
            title="Ducts"><i class="fa fa-superpowers"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref class="active" title="Poles"><i
                class="fa fa-arrows-v"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/ne');"
            title="Network Equipment"><i class="fa fa-server"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/rack');"
            title="Racks"><i class="fa fa-list-ol"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/site');"
            title="Sites"><i class="fa fa-building-o"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/service');"
            title="Services"><i class="fa fa-tty"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/trench');"
            title="Trenches"><i class="fa fa-arrows-h"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/trenchLifetime');"
            title="Trenches (lifetime)"><i class="fa fa-vine"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/provider');"
            title="Providers"><i class="fa fa-handshake-o"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/alert');"
            title="Alerts"><i class="fa fa-bullhorn"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/setting');"
            title="Settings"><i class="fa fa-cog"></i></a>
        <a nohref onclick="window.alert('<%=payload.appName%> v<%=payload.appVersion%>.<%=payload.appBuild%>');
            return false;" title="About"><i class="fa fa-info-circle"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="return jump('<%=payload.rootUrl%>/help');"
            title="Help"><i class="fa fa-question-circle"></i></a>
        <a onmouseover="" style="cursor: pointer;" nohref onclick="logout();" title="Quit"><i
                class="fa fa-window-close"></i></a>
        <a nohref onmouseover="" style="cursor: pointer;" accesskey="h" onclick="toggleDiv('icon-bar');return false;"
            title="Toggle Bar | Mac <ctrl><opt>H | Windows: <alt><shift> |"><i class="fa fa-bars"></i></a>
    </div>
    <div class="wrapper">
        <div class="mapVendor-select" id="mapVendorList">
            <label for="mapVendor">Map Vendor</label>
            <select id="mapVendor"></select>
        </div>
        <div class="pole-select" id="poleList">
            <label for="poleId">pole</label>
            <select id="poleId" onchange="if(this.selectedIndex !== undefined) fetchPolePoints();"></select>
            <a accesskey="@" nohref onclick="fetchListPoles();" onmouseover="" title="refresh"
                style="cursor: pointer;"><i style="color:white;" class="fa fa-refresh"></i></a>
            <label for="polePoint">Point</label>
            <select id="polePoint" onchange="if(this.selectedIndex !== undefined) fetchPole();"></select>
            <label for="poleHeight">Height</label>
            <input type="text" id="poleHeight" disabled></select>
            <label for="poleClassifier">Classifier</label>
            <input type="text" id="poleClassifier" disabled></select>
        </div>
    </div>
    <div class="map" id="map"></div>
    <div class="footer">
        <p>Â© 2024-2025 Merkator nv/sa. All rights reserved.</p>
    </div>
</body>

</html>